## comparing hydro toad to treglia toad

library(raster)
library(randomForest)
library(sf)
library(tidyverse)
library(mapview)
library(tidylog)


# Treglia Results ---------------------------------------------------------

pred1<-raster("original_model/Current/randomForests/PARTITIONING/Cur_10x_Final_Feb2014/Model1/SppProbs.img")
pred2<-raster("original_model/Current/randomForests/PARTITIONING/Cur_10x_Final_Feb2014/Model2/SppProbs.img")
pred3<-raster("original_model/Current/randomForests/PARTITIONING/Cur_10x_Final_Feb2014/Model3/SppProbs.img")
pred4<-raster("original_model/Current/randomForests/PARTITIONING/Cur_10x_Final_Feb2014/Model4/SppProbs.img")
pred5<-raster("original_model/Current/randomForests/PARTITIONING/Cur_10x_Final_Feb2014/Model5/SppProbs.img")
pred6<-raster("original_model/Current/randomForests/PARTITIONING/Cur_10x_Final_Feb2014/Model6/SppProbs.img")
pred7<-raster("original_model/Current/randomForests/PARTITIONING/Cur_10x_Final_Feb2014/Model7/SppProbs.img")
pred8<-raster("original_model/Current/randomForests/PARTITIONING/Cur_10x_Final_Feb2014/Model8/SppProbs.img")
pred9<-raster("original_model/Current/randomForests/PARTITIONING/Cur_10x_Final_Feb2014/Model9/SppProbs.img")
pred10<-raster("original_model/Current/randomForests/PARTITIONING/Cur_10x_Final_Feb2014/Model10/SppProbs.img")

allPred <- stack(pred1, pred2,pred3,pred4,pred5,pred6,pred7,pred8,pred9,pred10)
allPred

r_mean <- calc(allPred, mean)
r_mean
# Upload data -------------------------------------------------------------

## model with hydro
hYdMod <- read.csv("ignore/ModelResults/Gridded/03_Av_Probs_Current_RB9.csv")
hYdMod

## raster results - probability
myModProb <- raster("ignore/ModelResults/Gridded/Arroyo_Toad_Prob_Occurrence_RB9.tif")
myModProb

## raster results - presence/absence
myModPres <- raster("ignore/ModelResults/Gridded/Arroyo_Toad_PresAbs_Occurrence_RB9.tif")
myModPres

# ## observations
load(file=paste0("ignore/ModelResults/Gridded/Model1/all_presAbs_env_data.RData"))
head(NewDataObsSub)

## get mask raster
bmask <- raster("input_data/Elev.tif")

## Treglia model - landscape and climate
# crs(allPred)

## resample treglia results to match my results: crs and grids
re_allPred <- resample(allPred, bmask, method = "bilinear")

## add my mod to raster stack

allD <- stack(myModProb, myModPres)

## create dataframe
allPreddf <- as.data.frame(allD, xy=T)
allPreddf <- na.omit(allPreddf)

## row names are cells, add as column

allPreddf$cells <- rownames(allPreddf)
allPreddf
dim(allPreddf) ## 16,021
## pivot treglia probs longer to make average

allPreddf_long <- allPreddf %>%
  pivot_longer(Layer_1.1:Layer_1.10, names_to = "Model", values_to = "Value")


## group by cells and take average of models
meanTreg <- allPreddf_long %>%
  group_by(x,y, Arroyo_Toad_Prob_Occurrence_RB9, cells) %>%
  summarise(TregMeanProb = mean(Value))

meanTreg

#### observations for comparison

probs_sf <- hYdMod %>%
  st_as_sf(coords=c("x", "y"), crs=crs(bmask), remove=F) 

## get obs and format. makespatial 
obs <- NewDataObsSub %>% as.data.frame() %>%
  dplyr::select(PresAbs, cells) %>%
  inner_join(probs_sf, by = c("cells")) %>%
  st_as_sf(coords=c("x", "y"), crs=crs(bmask), remove=F) %>%
  mutate(cells = as.character(cells)) %>%
  select(PresAbs, cells)
  obs

# Comparison --------------------------------------------------------------

## start simple - correlation

cor(meanTreg$Arroyo_Toad_Prob_Occurrence_RB9, meanTreg$TregMeanProb)
## 0.6468656

wilcox.test(meanTreg$Arroyo_Toad_Prob_Occurrence_RB9, meanTreg$TregMeanProb)
## p-value < 2.2e-16

## calculate difference
# covert probablilties to presence/absence - use 0.5 as crude estimate for threshold, good enough for comparison
DiffTreg <- meanTreg %>%
  mutate(Diffs = Arroyo_Toad_Prob_Occurrence_RB9-TregMeanProb) %>%
  mutate(Diffs2 = ifelse(Diffs >= -0.1 & Diffs <= 0.1, 0, Diffs)) %>%
  mutate(TregPresAbs = ifelse(TregMeanProb <0.535, 0,1),
         MyPresAbs = ifelse(Arroyo_Toad_Prob_Occurrence_RB9 < 0.535, 0, 1))

## make spatial
# DiffTreg_sp <- st_as_sf(DiffTreg, st_as_sf(coords=c("x", "y"), crs=crs(bmask), remove=F))
DiffTreg_sp <- DiffTreg
coordinates(DiffTreg_sp) <- c("x", "y")
crs(DiffTreg_sp) <- crs(bmask)
DiffTreg
## map of differences

basemapsList <- c("Esri.WorldTopoMap", "Esri.WorldImagery",
                  "Esri.NatGeoWorldMap",
                  "OpenTopoMap", "OpenStreetMap", 
                  "CartoDB.Positron", "Stamen.TopOSMFeatures")

mapviewOptions(basemaps=basemapsList, vector.palette = colorRampPalette(c(  "red", "green")) , fgb = FALSE)

## red = my mod predicts lower, green = my mod predicts higher
m1 <- mapview(DiffTreg_sp, zcol = "Diffs",  cex = 3, legend = TRUE, layer.name = "Difference in Probability of Occurrence") +
mapview(subset(obs, PresAbs == 1), col.regions = "black",cex = 2.5, layer.name = "Observations")

m1@map %>% leaflet::addMeasure(primaryLengthUnit = "meters")

# mapshot(m1, url = paste0(getwd(), "/ignore/ModelResults/Gridded/Arroyo_Toad_Prob_Occurrence_RB9.html"),
#         file = paste0(getwd(), "/ignore/ModelResults/Gridded/Arroyo_Toad_Prob_Occurrence_RB9.png"))
# getwd()


# Presence/absence comparison ---------------------------------------------

## count presences
sum(DiffTreg_sp$TregPresAbs) ## 3044
sum(DiffTreg_sp$MyPresAbs) ## 2368

 m1 <- #mapview(DiffTreg_sp, zcol = "Diffs",  cex = 3, legend = TRUE, layer.name = "Difference in Probability of Occurrence") +
  mapview(subset(DiffTreg_sp, TregPresAbs == 1), col.regions = "green",cex = 2.5, layer.name = "Treglia Presences") +
    mapview(subset(DiffTreg_sp, MyPresAbs == 1), col.regions = "red",cex = 2.5, layer.name = "My Presences") +
   mapview(subset(obs, PresAbs == 1), col.regions = "black",cex = 2.5, layer.name = "Observations")

m1@map %>% leaflet::addMeasure(primaryLengthUnit = "meters")

## make column where all 3 are same grid: obs, treg and my mod all predicting

DiffTreg <- meanTreg %>%
  mutate(Diffs = Arroyo_Toad_Prob_Occurrence_RB9-TregMeanProb) %>%
  mutate(Diffs2 = ifelse(Diffs >= -0.1 & Diffs <= 0.1, 0, Diffs)) %>%
  mutate(TregPresAbs = ifelse(TregMeanProb <0.535, 0,1),
         MyPresAbs = ifelse(Arroyo_Toad_Prob_Occurrence_RB9 < 0.535, 0, 1)) %>%
  full_join(obs, by = "cells") %>%
  drop_na(x) %>%
  mutate(AllThreePreds = TregPresAbs + MyPresAbs + PresAbs)

## make spatial

DiffTreg_sp <- DiffTreg
coordinates(DiffTreg_sp) <- c("x", "y")
crs(DiffTreg_sp) <- crs(bmask)
DiffTreg
sum(na.omit(DiffTreg_sp$AllThreePreds ==3)) ##  824

## map of differences

basemapsList <- c("Esri.WorldTopoMap", "Esri.WorldImagery",
                  "Esri.NatGeoWorldMap",
                  "OpenTopoMap", "OpenStreetMap", 
                  "CartoDB.Positron", "Stamen.TopOSMFeatures")

mapviewOptions(basemaps=basemapsList, vector.palette = colorRampPalette(c(  "red", "green")) , fgb = FALSE)

## red = my mod predicts lower, green = my mod predicts higher
m1 <- mapview(subset(DiffTreg_sp, TregPresAbs == 1), col.regions = "green",cex = 2.5, layer.name = "Treglia Presences") +
  mapview(subset(DiffTreg_sp, MyPresAbs == 1), col.regions = "red",cex = 2.5, layer.name = "My Presences") +
  mapview(subset(DiffTreg_sp, PresAbs == 1), col.regions = "orange",cex = 2.5, layer.name = "Observations") +
  mapview(subset(DiffTreg_sp, AllThreePreds == 3), col.regions = "black",cex = 2.5, layer.name = "Both Models match Observations") 

m1@map %>% leaflet::addMeasure(primaryLengthUnit = "meters")
