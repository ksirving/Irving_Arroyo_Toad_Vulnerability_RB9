#### elevation of predictions
### predictions on protected land

library(raster)
library(randomForest)
library(sf)
library(tidyverse)
library(mapview)
library(tidylog)
library(cowplot)

## standard error function
std <- function(x) sd(x)/sqrt(length(x))

# Treglia Results ---------------------------------------------------------

# pred1<-raster("original_model/Current/randomForests/PARTITIONING/Cur_10x_Final_Feb2014/Model1/SppProbs.img")
# pred2<-raster("original_model/Current/randomForests/PARTITIONING/Cur_10x_Final_Feb2014/Model2/SppProbs.img")
# pred3<-raster("original_model/Current/randomForests/PARTITIONING/Cur_10x_Final_Feb2014/Model3/SppProbs.img")
# pred4<-raster("original_model/Current/randomForests/PARTITIONING/Cur_10x_Final_Feb2014/Model4/SppProbs.img")
# pred5<-raster("original_model/Current/randomForests/PARTITIONING/Cur_10x_Final_Feb2014/Model5/SppProbs.img")
# pred6<-raster("original_model/Current/randomForests/PARTITIONING/Cur_10x_Final_Feb2014/Model6/SppProbs.img")
# pred7<-raster("original_model/Current/randomForests/PARTITIONING/Cur_10x_Final_Feb2014/Model7/SppProbs.img")
# pred8<-raster("original_model/Current/randomForests/PARTITIONING/Cur_10x_Final_Feb2014/Model8/SppProbs.img")
# pred9<-raster("original_model/Current/randomForests/PARTITIONING/Cur_10x_Final_Feb2014/Model9/SppProbs.img")
# pred10<-raster("original_model/Current/randomForests/PARTITIONING/Cur_10x_Final_Feb2014/Model10/SppProbs.img")
# 
# allPred <- stack(pred1, pred2,pred3,pred4,pred5,pred6,pred7,pred8,pred9,pred10)
# allPred
# 
# ## get mask raster
# bmask <- raster("input_data/Elev.tif")
# 
# r_mean <- calc(allPred, mean)
# r_mean
# 
# ## resample treglia results to match my results: crs and grids
# re_allPred <- resample(r_mean, bmask, method = "bilinear")

# Upload data ------------------------------------------------------

## model with hydro
hYdMod <- read.csv("ignore/ModelResults/Gridded/03_Av_Probs_Current_RB9.csv")
mean(hYdMod$MeanProb) ## 0.3 - average predicted probability, ok to use as it's as good as more complex methods (Liu, 2005)
## 0.535 cut off maximising sensitivity and specificity (more conservative) but better - Liu 2005, 2010?
head(hYdMod)

## raster results - probability
myModProb <- raster("ignore/ModelResults/Gridded/Arroyo_Toad_Prob_Occurrence_RB9.tif")
myModProb

## scenario results
scenProbs <- read.csv("ignore/FuturePredictions/05_Av_Probs_Future_RB9_extremes.csv") %>%
  select(-c(X, Index:deltaSeasonality))
scenProbs


# ## observations
load(file=paste0("ignore/ModelResults/Gridded/Model1/all_presAbs_env_data.RData"))
head(NewDataObsSub)

## take just cells and presabs from obs 

obs <- NewDataObsSub %>%
  select(PresAbs, cells)

head(obs)

## upload elevation
elev <- raster("input_data/Elev.tif")

## stack elevation and predictions

alldataR <- stack(myModProb, elev)

## convert to data frame
alldataDF <- as.data.frame(alldataR, xy=T)
alldataDF <- na.omit(alldataDF)
dim(alldataDF) ##  16,021
## row names are cells, add as column

alldataDF$cells <- rownames(alldataDF)
alldataDF$cells <- as.numeric(alldataDF$cells)

## change names
names(alldataDF)

alldataDF <- alldataDF %>%
  rename(ProbOcc = Arroyo_Toad_Prob_Occurrence_RB9)

## join with obs

dataObs <- full_join(alldataDF, obs, by = "cells")

dataObs <- full_join(dataObs, scenProbs, by = c("cells")) %>%
  select(-c(x.x, y.x)) %>%
  rename(x = x.y, y = y.y)
head(dataObs)


# elevation of observations -----------------------------------------------

## keep only 1 and 0 (remove NAs) from presence absence
dataObsx <- dataObs %>%
  drop_na(PresAbs) %>%
  mutate(PresAbs = factor(PresAbs, levels = c("1","0"), labels = c("Presence", "Absence")))

# ?as.factor

b1 <- ggplot(dataObsx, aes(x=PresAbs, y = Elev, fill = PresAbs)) +
  geom_boxplot() +
  scale_x_discrete(name = "") +
  scale_y_continuous(name = "Elevation (ft)") +
  theme_classic() +
  labs(fill = "")

b1

file.name1 <- "Figures/07_observations_elevation.jpg"
ggsave(b1, filename=file.name1, dpi=300, height=5, width=8)



# elevation of predictions ------------------------------------------------

head(dataObs2)

## convert prob to binary
dataObs2 <- dataObs %>%
  mutate(MyPresAbs = ifelse(ProbOcc < 0.535, 0, 1)) %>%
  mutate(MyPresAbs = factor(MyPresAbs, levels = c("1","0"), labels = c("Presence", "Absence"))) %>%
  select(-c(MeanProb, Scenario2, Scenario)) %>% distinct()


## take only presence grids
PresOnly <- dataObs2 %>%
  filter(MyPresAbs == "Presence")

dataObs2
## box plot
b2 <- ggplot(PresOnly, aes(x=PresAbs, y = Elev)) +
  geom_boxplot() +
  theme(axis.text.x = element_blank()) +
  scale_x_discrete(name = "Scenario") +
  scale_y_continuous(name = "Elevation (m)") +
  theme_classic() +
  labs(fill = "")

b2

file.name1 <- "Figures/07_CURRENT_Predictions_elevation.jpg"
ggsave(b2, filename=file.name1, dpi=300, height=5, width=8)



# Upload protected land data ----------------------------------------------

## military land - incl camp pendleton
milProLand <- st_read("ignore/Protected_Land/R9_Military/R9_Military.shp")
milProLand

plot(milProLand[1])

## open space lands that have been protected for open space uses through fee ownerships

Pland <- st_read("ignore/Protected_Land/CPAD_2023a_Holdings.shp")
names(dataObs)
# raster data df 
## make spatial
dataObsSP <- dataObs %>%
  drop_na(x) %>%
  st_as_sf(coords=c( "x", "y"), crs=crs(alldataR), remove=F) 

class(dataObsSP)

## make land use data same CRS
Pland <- Pland %>%
  st_transform(crs=st_crs(alldataR)) 

## check same crs
crs(Pland) == crs(dataObsSP)

## join pland poly to point data

PlandDataObsJoin <- st_join(dataObsSP,Pland) 

## save out
st_write(PlandDataObsJoin, "ignore/Protected_Land/07_joined_land_and_mod_data.shp", append=F)

## count presences in protected land

## add column of wehther in prootected ,and of=r no

PlandDataObsJoin <- PlandDataObsJoin %>%
  mutate(Protected = ifelse(is.na(UNIT_NAME), "No", "Yes"))

PlandDataObsJoin
## convert to p/a

PlandDataObsJoin <- PlandDataObsJoin %>%
  mutate(MyPresAbs = ifelse(ProbOcc < 0.535, 0, 1)) %>%
  mutate(MyPresAbs = factor(MyPresAbs, levels = c("1","0"), labels = c("Presence", "Absence")))  %>%
  select(-c(MeanProb, Scenario2, Scenario)) %>% distinct()

## get summary states of presences on protected land
sumScens <- PlandDataObsJoin %>% as.data.frame() %>%
  select(-c( geometry)) %>%
  # filter(FuturePresAbs == "Presence") %>% ## only presences
  group_by(Protected, MyPresAbs) %>%
  summarise(Presences = length(MyPresAbs)) %>%
  pivot_wider(names_from = "MyPresAbs", values_from = "Presences") %>%
  ungroup(Protected) %>%
  mutate(TotalCellsP = sum(Presence), TotalCellsA = sum(Absence)) %>%
  group_by(Protected) %>%
  mutate(ProportionP = (Presence/TotalCellsP)*100) %>%
  mutate(ProportionA = (Absence/TotalCellsA)*100) 

sumScens

write.csv(sumScens, "Tables/07a_number_presences_on_prot_land_current_spatial.csv")

## make percentage table - presences
perctabP <- sumScens %>% as.data.frame() %>%
  select(-c(Presence, Absence, TotalCellsP,  TotalCellsA, ProportionA)) %>%
  pivot_wider(names_from="Protected", values_from = "ProportionP") %>%
  # pivot_wider(names_from="Protected", values_from = "ProportionA") %>%
  select(-No) %>%
  drop_na()
# pivot_wider(names_from = FuturePresAbs, values_from = Yes)

perctabP

## absences
perctabA <- sumScens %>% as.data.frame() %>%
  select(-c(Presence, Absence, TotalCellsP,  TotalCellsA, ProportionP)) %>%
  pivot_wider(names_from="Protected", values_from = "ProportionA") %>%
  # pivot_wider(names_from="Protected", values_from = "ProportionA") %>%
  select(-No) %>%
  drop_na()
# pivot_wider(names_from = FuturePresAbs, values_from = Yes)

perctabA

write.csv(perctab, "Tables/07_proportion_presences_on_prot_land_future_scens.csv")


# Map predicted presences on protected land -------------------------------

## upload RB9 poly
cnts <- st_read("/Users/katieirving/Library/CloudStorage/OneDrive-SharedLibraries-SCCWRP/SD Hydro Vulnerability Assessment - General/Data/SpatialData/SD_RB9_boundary.shp") %>%
  st_transform(crs=st_crs(alldataR)) 
cnts

## polygons of protected land
## join with pland
rb9pl <- st_join(Pland, cnts, left = F)
rb9pl ## geom is the protected land

## take only columns of interest and distinct rows, join with model data, and create presabs column based on 0.5 threshold
Plandx <- rb9pl %>%
  select(UNIT_ID, AGNCY_TYP) %>%
  filter(!UNIT_ID == 5778) %>%
  distinct(UNIT_ID, .keep_all =T) %>%
  st_join(dataObsSP) %>%
  drop_na(cells) %>%
  # mutate(MyPresAbs = ifelse(MyMod < 0.5, 0, 1)) %>%
  mutate(MyPresAbs = factor(MyPresAbs, levels = c("1","0"), labels = c("Presence", "Absence")))

Plandx 
length(unique(Plandx$UNIT_ID)) ## 175 units of portected land in total

## still some protected land outside of study area
names(PlandDataObsJoin)

## Presence Points
## filter from main df
presProt <- PlandDataObsJoin %>%
  filter(MyPresAbs == "Presence", Protected == "Yes") 

presNot <- PlandDataObsJoin %>%
  filter(MyPresAbs == "Presence", Protected == "No")
presNot

## plot
ggplot() +
  geom_sf(data=cnts) + ## rb9 boundary
  geom_sf(data=Plandx) + ## protected land
  geom_sf(data=pres, aes(fill=as.factor(NperPLPoly)), pch=21, size=2) +
  # geom_sf(data)
  theme_bw()+
  scale_fill_viridis_d("Presence On Protected Land?")+
  ggtitle("Predicted Presences on Protected Land")


## plot in mapview
basemapsList <- c("Esri.WorldTopoMap", "Esri.WorldImagery",
                  "Esri.NatGeoWorldMap",
                  "OpenTopoMap", "OpenStreetMap", 
                  "CartoDB.Positron", "Stamen.TopOSMFeatures")

# mapviewOptions(basemaps=basemapsList, vector.palette = colorRampPalette(c(  "red", "green")) , fgb = FALSE)
mapviewOptions(fgb = FALSE)


m1 <- mapview(Plandx, col.regions = "green",cex = 2.5, layer.name = "Protected Land") +
  mapview(cnts, color = "black", col.regions = "grey", alpha.regions = 0.2,  layer.name = "San Diego Region") +
  mapview(presProt, color = "blue",cex = 1, alpha.regions = 0,alpha = 1, layer.name = "Presences Predicted on Protected Land") +
  mapview(presNot, color = "red",cex = 1, alpha.regions = 0, alpha = 1, layer.name = "Presences Not Predicted on Protected Land")
m1


m1@map %>% leaflet::addMeasure(primaryLengthUnit = "meters")

mapshot(m1, url = paste0(getwd(), "/ignore/Protected_Land/07_predictions_on_protected_land.html"),
        file = paste0(getwd(), "/ignore/Protected_Land/07_predictions_on_protected_land.png"))
getwd()

### Upload critical habitat data ----------------------------------------------

CHab <- st_read("ignore/Critical_Habitat/ArroyoToadFinalCriticalHabitatUSFWSds129.shp")

# raster data df 
## make spatial
dataObsSP <- dataObs %>%
  drop_na(x) %>%
  st_as_sf(coords=c( "x", "y"), crs=crs(alldataR), remove=F) 

class(dataObsSP)

## make land use data same CRS
CHab <- CHab %>%
  st_transform(crs=st_crs(alldataR)) 

## check same crs
crs(CHab) == crs(dataObsSP)

## join pland poly to point data

CHabDataObsJoin <- st_join(dataObsSP,CHab) 
CHabDataObsJoin

## save out
st_write(CHabDataObsJoin, "ignore/Protected_Land/07_joined_critical_habitat_and_mod_data.shp", append=F)

## count presences in protected land

## add column of wehther in prootected ,and of=r no

CHabDataObsJoin <- CHabDataObsJoin %>%
  mutate(Critical = ifelse(is.na(SUBUNIT), "No", "Yes"))

## convert to p/a

CHabDataObsJoin <- CHabDataObsJoin %>%
  mutate(MyPresAbs = ifelse(ProbOcc < 0.535, 0, 1)) %>%
  mutate(MyPresAbs = factor(MyPresAbs, levels = c("1","0"), labels = c("Presence", "Absence"))) %>%
  mutate(FuturePresAbs = ifelse(MeanProb < 0.535, 0, 1)) %>%
  mutate(FuturePresAbs = factor(FuturePresAbs, levels = c("1","0"), labels = c("Presence", "Absence"))) %>%
  drop_na(MyPresAbs, FuturePresAbs, Scenario2)

## get summary states of presences on protected land
sumScens <- CHabDataObsJoin %>% as.data.frame() %>%
  select(-geometry) %>%
  filter(FuturePresAbs == "Presence") %>% ## only presences
  group_by(Scenario2, Critical) %>%
  summarise(Presences = length(FuturePresAbs)) %>%
  ungroup(Critical) %>%
  mutate(TotalCells = sum(Presences)) %>%
  group_by(Critical) %>%
  mutate(Proportion = (Presences/TotalCells)*100) 
sumScens

write.csv(sumScens, "Tables/07_number_presences_on_critical_habitat_future_scens.csv")

sumScensWide <- sumScens %>%
  select(-Proportion) %>%
  pivot_wider(names_from = Critical, values_from = Presences)

sumScensWide

write.csv(sumScensWide, "Tables/07_number_presences_on_critical_habitat_future_scens_wide.csv")

## make percentage table 
perctab <- sumScens %>% as.data.frame() %>%
  select(-c(Presences, TotalCells)) %>%
  pivot_wider(names_from="Critical", values_from = "Proportion")

perctab

write.csv(perctab, "Tables/07_proportion_presences_on_critical_habitat_future_scens.csv")


## counts
# length(CHabDataObsJoin$cells) ## 16,021 grid cells
# sum(CHabDataObsJoin$MyPresAbs == "Presence") ## 2119 predicted presence in study area
# sum(CHabDataObsJoin$Critical == "Yes") ## 2271 points are in critical land in total
# sum(CHabDataObsJoin$Critical == "Yes"& CHabDataObsJoin$MyPresAbs == "Presence") ## 936 presences are in critical land in total
# sum(na.omit(CHabDataObsJoin$Critical == "Yes"& CHabDataObsJoin$PresAbs == 1)) ## 423 observations are in critical land in total
# 
# cts <- as.data.frame(CHabDataObsJoin %>% 
#                        group_by(Critical) %>% 
#                        summarise(MyModPLPresence = sum(MyPresAbs == "Presence"),
#                                  MyModPLAbsence = sum(MyPresAbs == "Absence"),
#                                  Obs = sum(na.omit(PresAbs == 1))))
# 
# cts$geometry <- NULL
# cts
# 
# write.csv(cts, "Tables/07_critical_habitat_presences.csv")
# Critical MyModPLPresence        MyModPLAbsence Obs
# No            1183                      12567 544 
# Yes             936                     1335 423 

## 2119 predicted presences in study area
## 936 are on critical land - ~44%
## 1183 are not on critical land - ~56%

## 967 toad observations in total
## 544 are on critical land - ~ 56%
## 423 are not on critical land - ~44%

# Map presences on critical habitat ---------------------------------------

## upload RB9 poly
cnts <- st_read("/Users/katieirving/Library/CloudStorage/OneDrive-SharedLibraries-SCCWRP/SD Hydro Vulnerability Assessment - General/Data/SpatialData/SD_RB9_boundary.shp") %>%
  st_transform(crs=st_crs(alldataR)) 
cnts

## polygons of protected land
## join with CHab
rb9pl <- st_join(CHab, cnts, left = F)
rb9pl ## geom is the protected land

## take only columns of interest and distinct rows, join with model data, and create presabs column based on 0.5 threshold
CHabx <- rb9pl %>%
  # select(UNIT_ID, AGNCY_TYP) %>%
  # filter(!UNIT_ID == 5778) %>%
  # distinct(UNIT_ID, .keep_all =T) %>%
  st_join(dataObsSP) %>%
  drop_na(cells) #%>%
# mutate(MyPresAbs = ifelse(MyMod < 0.5, 0, 1)) %>%
# mutate(MyPresAbs = factor(MyPresAbs, levels = c("1","0"), labels = c("Presence", "Absence")))

CHabx 
length(unique(CHabx$SUBUNIT)) ## 5 units of critical land in total


## Presence Points
## filter from main df
presProt <- CHabDataObsJoin %>%
  filter(MyPresAbs == "Presence", Critical == "Yes") 

presNot <- CHabDataObsJoin %>%
  filter(MyPresAbs == "Presence", Critical == "No")
presNot


# Maps --------------------------------------------------------------------
# install.packages(c("USAboundaries", "rnaturalearth", "GSODR"))
# install.packages("basemaps")
# devtools::install_github("16EAGLE/basemaps")
library(basemaps)

# install.packages('osmdata')
library(osmdata)

lisbon_map <- get_map( getbb('lisbon'), source="stamen")

library(here)
library(viridis)
# library(USAboundaries) ## not available for r version, has been archived on cran
library(rnaturalearth)
library(GSODR)
library(ggrepel)
library(cowplot)
library(ggmap)

## transform to 3857

cntsx <- cnts %>% 
  st_transform(crs= 3857, remove=F) 

cntsx

## plot
m1 <- ggplot() +
  # basemap_ggplot(cntsx) +
  geom_sf(data=cnts) + ## rb9 boundary
  geom_sf(data=CHabx) + ## critical habitat
  geom_sf(data=presProt, fill = "green", pch=21, size=2) +
  geom_sf(data=presNot, fill = "red", pch=21, size=2) +
  # geom_sf(data)
  theme_bw()+
  scale_fill_viridis_d("Presence On Critical Habitat")+
  ggtitle("Predicted Presences in Critical Habitat")
m1

file.name1 <- "Figures/07_presence_on_critical_habitat.jpg"
ggsave(m1, filename=file.name1, dpi=300, height=5, width=8)


## plot in mapview
basemapsList <- c("Esri.WorldTopoMap", "Esri.WorldImagery",
                  "Esri.NatGeoWorldMap",
                  "OpenTopoMap", "OpenStreetMap", 
                  "CartoDB.Positron", "Stamen.TopOSMFeatures")

mapviewOptions(basemaps=basemapsList, fgb = FALSE)



m1 <- #mapview(CHabx, col.regions = "green",cex = 2.5, layer.name = "Critical Habitat") # +
  mapview(cnts, color = "black", col.regions = "grey", alpha.regions = 0.2,  layer.name = "San Diego Region") +
  mapview(presProt, color = "blue",cex = 1, alpha.regions = 0,alpha = 1, layer.name = "Presences Predicted on Protected Land") +
  mapview(presNot, color = "red",cex = 1, alpha.regions = 0, alpha = 1, layer.name = "Presences Not Predicted on Protected Land")

m1


m1@map %>% leaflet::addMeasure(primaryLengthUnit = "meters")

mapshot(m1, url = paste0(getwd(), "/ignore/Protected_Land/07_predictions_in_critical_habitat.html"),
        file = paste0(getwd(), "/ignore/Protected_Land/07_predictions_on_critical_habitat.png"))
getwd()
