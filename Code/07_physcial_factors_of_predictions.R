#### elevation of predictions
### predictions on protected land

library(raster)
library(randomForest)
library(sf)
library(tidyverse)
library(mapview)
library(tidylog)
library(cowplot)

## standard error function
std <- function(x) sd(x)/sqrt(length(x))

# Upload data ------------------------------------------------------

## model with hydro
hYdMod <- read.csv("ignore/ModelResults/Gridded/03_Av_Probs_Current_RB9.csv")
mean(hYdMod$MeanProb) ## 0.3 - average predicted probability, ok to use as it's as good as more complex methods (Liu, 2005)
## 0.535 cut off maximising sensitivity and specificity (more conservative) but better - Liu 2005, 2010?
head(hYdMod)

## raster results - probability
myModProb <- raster("ignore/ModelResults/Gridded/Arroyo_Toad_Prob_Occurrence_RB9.tif")
myModProb

## scenario results
scenProbs <- read.csv("ignore/FuturePredictions/05_Av_Probs_Future_RB9_extremes.csv") %>%
  select(-c(X, Index:deltaSeasonality))
scenProbs

# ## observations
load(file=paste0("ignore/ModelResults/Gridded/Model1/all_presAbs_env_data.RData"))
head(NewDataObsSub)

## take just cells and presabs from obs 

obs <- NewDataObsSub %>%
  select(PresAbs, cells)

head(obs)

## upload elevation
elev <- raster("input_data/Elev.tif")

## upload ffm
## ffm rasters
hyd1 <- raster("input_data/DS_Mag_50.tif")
hyd2 <- raster("input_data/FA_Mag.tif")
hyd3 <- raster("input_data/Peak_2.tif")
#hyd4 <- raster("input_data/Peak_5.tif")
hyd5 <- raster("input_data/Peak_10.tif")
hyd6 <- raster("input_data/Q99.tif")
hyd7 <- raster("input_data/SP_Mag.tif")
hyd8 <- raster("input_data/Wet_BFL_Mag_10.tif")
hyd9 <- raster("input_data/Wet_BFL_Mag_50.tif")

ffmR <- stack(hyd1, hyd2, hyd3,  hyd5, hyd6, hyd7, hyd8, hyd9)
ffmR


ffmRes <- resample(ffmR, elev, method = "bilinear")

## stack elevation, FFM and predictions

alldataR <- stack(myModProb, elev, ffmRes)

## convert to data frame
alldataDF <- as.data.frame(alldataR, xy=T)
alldataDF <- na.omit(alldataDF)
dim(alldataDF) ##  16,021

## row names are cells, add as column

alldataDF$cells <- rownames(alldataDF)
alldataDF$cells <- as.numeric(alldataDF$cells)

## change names
names(alldataDF)

alldataDF <- alldataDF %>%
  rename(ProbOcc = Arroyo_Toad_Prob_Occurrence_RB9)

## join with obs

dataObs <- full_join(alldataDF, obs, by = "cells") %>%
  distinct(cells, .keep_all = T)

length(unique(dataObs$cells)) ## 16017

sum(dataObs$ProbOcc > 0.535) ## 2119

dataObs <- full_join(dataObs, scenProbs, by = c("cells")) %>%
  select(-c(x.x, y.x)) %>%
  rename(x = x.y, y = y.y)

head(dataObs)

## convert prob to binary
dataObs2 <- dataObs %>%
  mutate(MyPresAbs = ifelse(ProbOcc < 0.535, 0, 1)) %>%
  mutate(MyPresAbs = factor(MyPresAbs, levels = c("1","0"), labels = c("Presence", "Absence"))) %>%
  mutate(FuturePresAbs = ifelse(MeanProb < 0.535, 0, 1)) %>%
  mutate(FuturePresAbs = factor(FuturePresAbs, levels = c("1","0"), labels = c("Presence", "Absence"))) %>%
  drop_na(MyPresAbs, FuturePresAbs, Scenario2) %>%
  pivot_longer(Elev:Wet_BFL_Mag_50, names_to = "Metric", values_to = "Values") %>%
  mutate(VariableHuman = case_when(Metric == "DS_Mag_50" ~ "Dry Season Baseflow",
                                   Metric == "Peak_10" ~ "Peak Flow: 10-Year Flood",
                                   Metric == "FA_Mag" ~ "Fall Pulse",
                                   Metric == "Peak_2" ~ "Peak Flow: 2-Year Flood",
                                   Metric == "Q99" ~ "Largest Annual Storm",
                                   Metric == "SP_Mag" ~ "Spring Recession",
                                   Metric == "Wet_BFL_Mag_10" ~ "Wet Season Baseflow (Low)",
                                   Metric == "Wet_BFL_Mag_50" ~ "Wet Season Baseflow (Med)",
                                   Metric == "Elev" ~ "Elevation")) %>%
  mutate(ValuesMS = Values*0.0283168) 


# elevation of observations -----------------------------------------------

## keep only 1 and 0 (remove NAs) from presence absence
dataObsx <- dataObs %>%
  drop_na(PresAbs) %>%
  mutate(PresAbs = factor(PresAbs, levels = c("1","0"), labels = c("Presence", "Absence")))

# ?as.factor

b1 <- ggplot(dataObsx, aes(x=PresAbs, y = Elev, fill = PresAbs)) +
  geom_boxplot() +
  scale_x_discrete(name = "") +
  scale_y_continuous(name = "Elevation (ft)") +
  theme_classic() +
  labs(fill = "")

b1

file.name1 <- "Figures/07_observations_elevation.jpg"
ggsave(b1, filename=file.name1, dpi=300, height=5, width=8)



# ffm and elevation of predictions ------------------------------------------------

#### summary stats on FFM and elevation

sumStats <- dataObs2 %>%
  group_by(FuturePresAbs, Scenario2, Metric) %>%
  summarise(meanVal = round(mean(ValuesMS), digits = 2),
            seVal = round(std(ValuesMS), digits = 2),
            maxVal = max(ValuesMS),
            minVal = min(ValuesMS)) %>%
  mutate(Mean_std = paste(meanVal, " +/- ", seVal)) 

sumStats

write.csv(sumStats, "Tables/07_elevation_FFM_sum_stats.csv")


sumStatsx <- sumStats %>%
  filter(FuturePresAbs == "Presence", !Metric == "Elev") %>%
  select(Scenario2, Metric, Mean_std) %>%
  pivot_wider(names_from = Metric, values_from = Mean_std)

sumStatsx

write.csv(sumStatsx, "Tables/07_elevation_FFM_sum_stats_wide.csv")

## compare presence only elevation with wilcoxon test - wilcox.test()

## take only presence grids
PresOnly <- dataObs2 %>%
  filter(FuturePresAbs == "Presence")

head(PresOnly)

## get baseline for comparison
basel <- PresOnly %>%
  filter(Scenario2 == "Baseline") %>%
  select(cells, MeanProb, Metric, Values)

## define scenarios
scens <- unique(PresOnly$Scenario2)[-2]
scens
scens[1]

## define Metrics
mets <- unique(PresOnly$Metric)
mets

## empty dataframe
df <- data.frame(matrix(ncol = 7))
colnames(df) <- c("Metric", "T_Statistic", "PValue", "DegreesOfFreedom", "nBaseline", "nFuture", "Scenario")

dfx <- NULL

for(m in 1:length(mets)) {
  
  PresOnlyx <- PresOnly %>%
    filter(Metric == mets[m])
  
  baselx <- basel %>%
    filter(Metric == mets[m]) 
  
  
  for(t in 1:length(scens)) {
    
    futscen <- PresOnlyx %>%
      filter(Scenario2 == scens[t]) %>%
      select(cells, MeanProb, Metric, Values) %>%
      rename(FutureMeanProb = MeanProb,
             FutureVal = Values) 
    
    ## join baseline and future elevation
    
    dat <- full_join(baselx, futscen, by = c("cells", "Metric")) 
    dat
    # wtest <- wilcox.test(dat$Elev, dat$FutureElev)
    
    ## t test with log transformed elevation
    ttest <- t.test(log(dat$Values), log(dat$FutureVal))
    ttest
    ## get stats
    df[t,1] <- mets[m]
    df[t,2] <- ttest$statistic
    df[t,3] <- ttest$p.value
    df[t,4] <- ttest$parameter
    df[t,5] <- length(na.omit(dat$Values))
    df[t,6] <- length(na.omit(dat$FutureVal))
    df[t,7] <- scens[t]
    
    dfx <- bind_rows(dfx, df)
    dfx
  
    }
  
}



ttest$statistic
ttest$parameter

df <- dfx %>%
  distinct()


df$PValueR <- round(df$PValue, digits=5)

write.csv(df, "Tables/07_elevation_ffm_ttests.csv")

head(dataObs2)

df <- read.csv("Tables/07_elevation_ffm_ttests.csv") %>%
  rename(Scenario2 = Scenario) %>% select(-X)
df

names(dataObs2)

## take only presence grids
PresOnly <- dataObs2 %>%
  full_join(df, by = c("Scenario2", "Metric")) %>%
  filter(FuturePresAbs == "Presence") %>%
  filter(!Metric == "Elev") %>% 
  mutate(pval_star = case_when(PValue < 0.01 ~ "**",
                               PValue < 0.05 ~ "*",
                               .default = ""))
unique(PresOnly$Metric)
# remove outliers to get whisker length for significant **

## function
filter_lims <- function(x){
  l <- boxplot.stats(x)$stats[1]
  u <- boxplot.stats(x)$stats[5]
  
  for (i in 1:length(x)){
    x[i] <- ifelse(x[i]>l & x[i]<u, x[i], NA)
  }
  return(x)
}

## reeplace outliers with NA
PresOnlyx <- PresOnly %>%
  group_by(Scenario2, VariableHuman) %>%
  mutate(ValuesMS2 = filter_lims(ValuesMS))
# lims_y <- c(0.4,1.5,18,150,30,41,0.4, 0.75)



## box plot for paper
b2 <- ggplot(PresOnlyx, aes(x=Scenario2, y = ValuesMS2, group = Scenario2, fill = Scenario2)) +
  geom_boxplot(outliers = FALSE) + ## removes outliers
  theme(axis.text.x = element_blank()) +
  facet_wrap(~VariableHuman, scales = "free_y") +
  scale_x_discrete(labels = NULL, name = "") +
  scale_y_continuous(name = expression(paste("Flow Magnitude (m"^3~"/s)")), expand = expansion(mult = c(0.1, 0.2))) +  # Adjust the expand values +
  theme_classic() +
  theme(legend.position = "bottom") +
  labs(fill = "") +
  # geom_text(aes(label = pval_star), nudge_y = 0.05)
  stat_summary(
    aes(label = pval_star), fun = function(x) max(x),
    geom = "text", vjust = -0.5, size = 4, col = "red"
  )

b2

file.name1 <- "Figures/07_Predictions_FFM.jpg"
ggsave(b2, filename=file.name1, dpi=300, height=8, width=12)

## boxplot with outliers

b3 <- ggplot(PresOnly, aes(x=Scenario2, y = ValuesMS, group = Scenario2, fill = Scenario2)) +
  geom_boxplot() + 
  theme(axis.text.x = element_blank()) +
  facet_wrap(~VariableHuman, scales = "free_y") +
  scale_x_discrete(labels = NULL, name = "") +
  scale_y_continuous(name = expression(paste("Flow Magnitude (m"^3~"/s)")), expand = expansion(mult = c(0.1, 0.2))) +  # Adjust the expand values +
  theme_classic() +
  theme(legend.position = "bottom") +
  labs(fill = "") +
  # geom_text(aes(label = pval_star), nudge_y = 0.05)
  stat_summary(
    aes(label = pval_star), fun = function(x) max(x),
    geom = "text", vjust = -0.5, size = 4, col = "red"
  )

b3

file.name1 <- "Figures/07_Predictions_FFM_with_outliers.jpg"
ggsave(b3, filename=file.name1, dpi=300, height=8, width=12)


# Upload protected land data ----------------------------------------------

## open space lands that have been protected for open space uses through fee ownerships

Pland <- st_read("ignore/Protected_Land/CPAD_2023a_Holdings.shp") 
names(dataObs)

## upload RB9 poly
cnts <- st_read("/Users/katieirving/Library/CloudStorage/OneDrive-SharedLibraries-SCCWRP/SD Hydro Vulnerability Assessment - General/Data/SpatialData/SD_RB9_boundary.shp") %>%
  st_transform(crs=st_crs(alldataR)) 
cnts

## make land use data same CRS
cnts <- cnts %>%
  st_transform(crs=st_crs(Pland)) 

## join with pland - subsets to rb9 region
rb9pl <- st_join(Pland, cnts, left = F)
rb9pl ## geom is the protected land
?st_join
head(Pland)
unique(rb9pl$COUNTY)
plot(rb9pl[1])
# ## upload RB9 poly
# cnts <- st_read("/Users/katieirving/Library/CloudStorage/OneDrive-SharedLibraries-SCCWRP/SD Hydro Vulnerability Assessment - General/Data/SpatialData/SD_RB9_boundary.shp") %>%
#   st_transform(crs=st_crs(alldataR)) 
# head(cnts)
# plot(cnts)

# st_crs(cnts) == st_crs(Pland)

# bboxRb9 <- bbox(cnts$geometry)
# ## mask protected land by RB9
# test <- raster::crop(Pland$geometry, cnts)
# test
# ?st_intersects
# ?crop
# ## upload pendleton polygon
# Pendleton <- st_read("ignore/Protected_Land/Pendleton_All.shp")
# 
# plot(Pendleton)

## make toad data spatial
dataObsSP <- dataObs2 %>%
  drop_na(x) %>%
  st_as_sf(coords=c( "x", "y"), crs=crs(alldataR), remove=F) 

class(dataObsSP)

## make land use data same CRS
Plandrb9 <- rb9pl %>%
  st_transform(crs=st_crs(alldataR)) 

## make pendleton data same CRS
# Pendleton <-Pendleton %>%
#   st_transform(crs=st_crs(alldataR)) 

## check same crs
crs(Plandrb9) == crs(dataObsSP)
# crs(Pland) == crs(Pendleton)

## join pendleton to main land use 

# test <- st_join(Pland, Pendleton)

## join pland poly to point data
st_crs(Plandrb9)

# Create a buffer around the polygon
buffered_polygon <- st_buffer(Plandrb9, dist = 50)

PlandDataObsJoin <- st_join(dataObsSP, buffered_polygon, join = st_within) 

### join pendleton to point data

# Create a buffer around the polygon
# buffered_polygon2 <- st_buffer(Pendleton, dist = 50)
# 
# PendDataObsJoin <- st_join(dataObsSP, buffered_polygon2, join = st_within) 


## save out
st_write(PlandDataObsJoin, "ignore/Protected_Land/07_joined_land_and_mod_data.shp", append=F)
# st_write(PendDataObsJoin, "ignore/Protected_Land/07_joined_pendleton_and_mod_data.shp", append=F)
# PlandDataObsJoin <- st_read("ignore/Protected_Land/07_joined_land_and_mod_data.shp")
## count presences in protected land

## add column of whether in protected

PlandDataObsJoin <- PlandDataObsJoin %>%
  mutate(Protected = ifelse(is.na(UNIT_NAME), "No", "Yes"))

PlandDataObsJoin

sum(PlandDataObsJoin$MyPresAbs == "Presence") ## 145026
## convert to p/a
# 
# PlandDataObsJoin <- PlandDataObsJoin %>%
#   mutate(MyPresAbs = ifelse(ProbOcc < 0.535, 0, 1)) %>%
#   mutate(MyPresAbs = factor(MyPresAbs, levels = c("1","0"), labels = c("Presence", "Absence"))) %>%
#   mutate(FuturePresAbs = ifelse(MeanProb < 0.535, 0, 1)) %>%
#   mutate(FuturePresAbs = factor(FuturePresAbs, levels = c("1","0"), labels = c("Presence", "Absence"))) 

## get summary states of presences on protected land
sumScens <- PlandDataObsJoin %>% as.data.frame() %>%
  select(-c( geometry)) %>%
  # filter(FuturePresAbs == "Presence") %>% ## only presences
  group_by(Scenario2, Protected, FuturePresAbs) %>%
  summarise(Presences = length(FuturePresAbs)) %>%
  pivot_wider(names_from = "FuturePresAbs", values_from = "Presences") %>%
  ungroup(Protected) %>%
  mutate(TotalCellsP = sum(Presence), TotalCellsA = sum(Absence)) %>%
  group_by(Protected) %>%
  mutate(ProportionP = (Presence/TotalCellsP)*100) %>%
  mutate(ProportionA = (Absence/TotalCellsA)*100) 

sumScens

write.csv(sumScens, "Tables/07_number_presences_on_prot_land_future_scens_spatial.csv")

## make percentage table - presences
perctabP <- sumScens %>% as.data.frame() %>%
  select(-c(Presence, Absence, TotalCellsP,  TotalCellsA, ProportionA)) %>%
  pivot_wider(names_from="Protected", values_from = "ProportionP") %>%
  # pivot_wider(names_from="Protected", values_from = "ProportionA") %>%
  select(-No) %>%
  drop_na()
  # pivot_wider(names_from = FuturePresAbs, values_from = Yes)

perctabP


write.csv(perctabP, "Tables/07_proportion_presences_on_prot_land_future_scens.csv")

## same for pendleton
# PendDataObsJoin <- PendDataObsJoin %>%
#   mutate(Protected = ifelse(is.na(Landuse), "No", "Yes"))
# 
# PendDataObsJoin
# 
# sum(PendDataObsJoin$MyPresAbs == "Presence") ## 132993
## convert to p/a
# 
# PlandDataObsJoin <- PlandDataObsJoin %>%
#   mutate(MyPresAbs = ifelse(ProbOcc < 0.535, 0, 1)) %>%
#   mutate(MyPresAbs = factor(MyPresAbs, levels = c("1","0"), labels = c("Presence", "Absence"))) %>%
#   mutate(FuturePresAbs = ifelse(MeanProb < 0.535, 0, 1)) %>%
#   mutate(FuturePresAbs = factor(FuturePresAbs, levels = c("1","0"), labels = c("Presence", "Absence"))) 

## get summary states of presences on protected land
# sumScens <- PendDataObsJoin %>% as.data.frame() %>%
#   select(-c( geometry)) %>%
#   # filter(FuturePresAbs == "Presence") %>% ## only presences
#   group_by(Scenario2, Protected, FuturePresAbs) %>%
#   summarise(Presences = length(FuturePresAbs)) %>%
#   pivot_wider(names_from = "FuturePresAbs", values_from = "Presences") %>%
#   ungroup(Protected) %>%
#   mutate(TotalCellsP = sum(Presence), TotalCellsA = sum(Absence)) %>%
#   group_by(Protected) %>%
#   mutate(ProportionP = (Presence/TotalCellsP)*100) %>%
#   mutate(ProportionA = (Absence/TotalCellsA)*100) 
# 
# sumScens
# 
# write.csv(sumScens, "Tables/07_number_presences_pendleton_future_scens_spatial.csv")
# 
# ## make percentage table - presences
# perctabP <- sumScens %>% as.data.frame() %>%
#   select(-c(Presence, Absence, TotalCellsP,  TotalCellsA, ProportionA)) %>%
#   pivot_wider(names_from="Protected", values_from = "ProportionP") %>%
#   # pivot_wider(names_from="Protected", values_from = "ProportionA") %>%
#   select(-No) %>%
#   drop_na()
# # pivot_wider(names_from = FuturePresAbs, values_from = Yes)
# 
# perctabP
# 
# ## absences
# perctabA <- sumScens %>% as.data.frame() %>%
#   select(-c(Presence, Absence, TotalCellsP,  TotalCellsA, ProportionP)) %>%
#   pivot_wider(names_from="Protected", values_from = "ProportionA") %>%
#   # pivot_wider(names_from="Protected", values_from = "ProportionA") %>%
#   select(-No) %>%
#   drop_na()
# # pivot_wider(names_from = FuturePresAbs, values_from = Yes)
# 
# perctabA
# 
# write.csv(perctabP, "Tables/07_proportion_presences_on_prot_land_future_scens.csv")

# Map predicted presences on protected land -------------------------------
## do not need for scenarios
## take only columns of interest and distinct rows, join with model data, and create presabs column based on 0.5 threshold
Plandx <- rb9pl %>%
  select(UNIT_ID, AGNCY_TYP) %>%
  filter(!UNIT_ID == 5778) %>%
  # distinct(UNIT_ID, .keep_all =T) %>%
  st_join(dataObsSP) %>%
  drop_na(cells) 
  # mutate(MyPresAbs = ifelse(MyMod < 0.5, 0, 1)) %>%
  # mutate(MyPresAbs = factor(MyPresAbs, levels = c("1","0"), labels = c("Presence", "Absence")))

Plandx 
length(unique(Plandx$UNIT_ID)) ## 301 units of portected land in total

## still some protected land outside of study area
names(PlandDataObsJoin)

## Presence Points
## filter from main df
presProtPL <- PlandDataObsJoin %>%
  filter(MyPresAbs == "Presence", Protected == "Yes") 

presNotPL <- PlandDataObsJoin %>%
  filter(MyPresAbs == "Presence", Protected == "No")
presNotPL

## upload ca boundary
ca_sf <- st_read("ignore/SpatialData/California/Ca_State_poly.shp")

## upload watersheds

sheds_sf<- st_read("ignore/SpatialData/SMCSheds2009/SMCSheds2009.shp") %>%
  filter(HUNAME %in% c("SAN JUAN", "SAN DIEGO", "SANTA MARGARITA", "SWEETWATER", "SAN DIEGUITO"))

plot(sheds_sf)


## create beige palet

beige_pal<-c("#f2dbb7","#eed9c4","#fff0db","#e4d5b7","#d9b99b",
             "#d9c2ba","#9c8481","#e2cbb0","#a69279","#f2dbb7",
             "#f6e6bf","#a69279","#f2dbb7","#9c8481","#e4d5b7")

## map presences on protected land
m1 <- ggplot()+
  # geom_sf(data=ca_sf)+ ## california
  geom_sf(data=sheds_sf, aes(fill=SMC_Name), color=NA)+ ## watersheds
  scale_fill_manual(values=beige_pal, guide= "none")+ ## beige colour for watersheds
  geom_sf(data=cnts) + ## rb9 boundary
  geom_sf(data=Plandx, fill = "orange") + ## protected land
  geom_sf(data=presProtPL, fill = "green", pch=21, size=2) +
  geom_sf(data=presNotPL, fill = "red", pch=21, size=2) +
  coord_sf(xlim=c(-117.82106,-116.4), ## axis limits
           ylim=c(32.5, 33.7),
           crs=4326) +
  theme_bw() +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold")) +
  theme(legend.text=element_text(size=14)) 
    # scale_fill_viridis_d("Presence On Protected Land")+
    # ggtitle("Predicted Presences on Protected Land")

m1

## create directory 
# file.name1 <- paste("Figures/03_observations_RB9.jpg")
# ## save
# ggsave(m1, filename=file.name1, dpi=500, height=10, width=15)

## plot
# basemap + 
#   geom_sf(data=cnts) + ## rb9 boundary
#   geom_sf(data=Plandx, fill = "orange") + ## protected land
#   # geom_sf(data=presProtPL, fill = "green", pch=21, size=2) +
#   # geom_sf(data=presNotPL, fill = "red", pch=21, size=2) +
#   # geom_sf(data)
#   theme_bw()+
#   scale_fill_viridis_d("Presence On Protected Land")+
#   ggtitle("Predicted Presences on Protected Land")
# 

### Upload critical habitat data ----------------------------------------------
  
CHab <- st_read("ignore/Critical_Habitat/ArroyoToadFinalCriticalHabitatUSFWSds129.shp")
plot(CHab)
CHab
## make land use data same CRS
cnts <- cnts %>%
  st_transform(crs=st_crs(CHab)) 

## join with pland - subsets to rb9 region
rb9CH <- st_join(CHab, cnts, left = F)
rb9CH ## geom is the critical habitat

head(Pland)
unique(rb9CH$RBNAME)
plot(rb9pl[1])
# raster data df 

## make spatial
dataObsSP <- dataObs2 %>%
  drop_na(x) %>%
  st_as_sf(coords=c( "x", "y"), crs=crs(alldataR), remove=F) 

class(dataObsSP)

## make land use data same CRS
rb9CH <- rb9CH %>%
  st_transform(crs=st_crs(alldataR)) 

## check same crs
crs(rb9CH) == crs(dataObsSP)

## join pland poly to point data
# Create a buffer around the polygon
buffered_polygonCH <- st_buffer(rb9CH, dist = 50)

CHabDataObsJoin <- st_join(dataObsSP, buffered_polygonCH, join = st_within) 

sum(CHabDataObsJoin$MyPresAbs == "Presence") ## 132993

length(unique(CHabDataObsJoin$cells))
length(CHabDataObsJoin$cells)


## save out
st_write(CHabDataObsJoin, "ignore/Protected_Land/07_joined_critical_habitat_and_mod_data.shp", append=F)

# CHabDataObsJoin <- st_read("ignore/Protected_Land/07_joined_critical_habitat_and_mod_data.shp")
## count presences in protected land

## add column of wehther in protected or not

CHabDataObsJoin <- CHabDataObsJoin %>%
  mutate(Critical = ifelse(is.na(UNIT), "No", "Yes"))

CHabDataObsJoin

## convert to p/a

# CHabDataObsJoin <- CHabDataObsJoin %>%
#   mutate(MyPresAbs = ifelse(ProbOcc < 0.535, 0, 1)) %>%
#   mutate(MyPresAbs = factor(MyPresAbs, levels = c("1","0"), labels = c("Presence", "Absence"))) %>%
#   mutate(FuturePresAbs = ifelse(MeanProb < 0.535, 0, 1)) %>%
#   mutate(FuturePresAbs = factor(FuturePresAbs, levels = c("1","0"), labels = c("Presence", "Absence"))) %>%
#   drop_na(MyPresAbs, FuturePresAbs, Scenario2)

## get summary states of presences on protected land
sumScens <- CHabDataObsJoin %>% as.data.frame() %>%
  select(-geometry) %>%
  filter(FuturePresAbs == "Presence") %>% ## only presences
  group_by(Scenario2, Critical) %>%
  summarise(Presences = length(FuturePresAbs)) %>%
  ungroup(Critical) %>%
  mutate(TotalCells = sum(Presences)) %>%
  group_by(Critical) %>%
  mutate(Proportion = (Presences/TotalCells)*100) 
sumScens

write.csv(sumScens, "Tables/07_number_presences_on_critical_habitat_future_scens.csv")

sumScensWide <- sumScens %>%
  select(-Proportion) %>%
  pivot_wider(names_from = Critical, values_from = Presences)

sumScensWide

write.csv(sumScensWide, "Tables/07_number_presences_on_critical_habitat_future_scens_wide.csv")

## make percentage table 
perctab <- sumScens %>% as.data.frame() %>%
  select(-c(Presences, TotalCells)) %>%
  pivot_wider(names_from="Critical", values_from = "Proportion")

perctab

write.csv(perctab, "Tables/07_proportion_presences_on_critical_habitat_future_scens.csv")


## counts
# length(CHabDataObsJoin$cells) ## 16,021 grid cells
# sum(CHabDataObsJoin$MyPresAbs == "Presence") ## 2119 predicted presence in study area
# sum(CHabDataObsJoin$Critical == "Yes") ## 2271 points are in critical land in total
# sum(CHabDataObsJoin$Critical == "Yes"& CHabDataObsJoin$MyPresAbs == "Presence") ## 936 presences are in critical land in total
# sum(na.omit(CHabDataObsJoin$Critical == "Yes"& CHabDataObsJoin$PresAbs == 1)) ## 423 observations are in critical land in total
# 
# cts <- as.data.frame(CHabDataObsJoin %>% 
#                        group_by(Critical) %>% 
#                        summarise(MyModPLPresence = sum(MyPresAbs == "Presence"),
#                                  MyModPLAbsence = sum(MyPresAbs == "Absence"),
#                                  Obs = sum(na.omit(PresAbs == 1))))
# 
# cts$geometry <- NULL
# cts
# 
# write.csv(cts, "Tables/07_critical_habitat_presences.csv")
# Critical MyModPLPresence        MyModPLAbsence Obs
# No            1183                      12567 544 
# Yes             936                     1335 423 

## 2119 predicted presences in study area
## 936 are on critical land - ~44%
## 1183 are not on critical land - ~56%

## 967 toad observations in total
## 544 are on critical land - ~ 56%
## 423 are not on critical land - ~44%

# Map presences on critical habitat ---------------------------------------
## don't think we need this
## upload RB9 poly
cnts <- st_read("/Users/katieirving/Library/CloudStorage/OneDrive-SharedLibraries-SCCWRP/SD Hydro Vulnerability Assessment - General/Data/SpatialData/SD_RB9_boundary.shp") %>%
  st_transform(crs=st_crs(alldataR)) 
cnts

## polygons of protected land
## join with CHab
rb9pl <- st_join(CHab, cnts, left = F)
rb9pl ## geom is the protected land

## take only columns of interest and distinct rows, join with model data, and create presabs column based on 0.5 threshold
CHabx <- rb9pl %>%
  # select(UNIT_ID, AGNCY_TYP) %>%
  # filter(!UNIT_ID == 5778) %>%
  # distinct(UNIT_ID, .keep_all =T) %>%
  st_join(dataObsSP) %>%
  drop_na(cells) %>%
  dplyr::select(cells) %>%
  distinct()
  # mutate(MyPresAbs = ifelse(MyMod < 0.5, 0, 1)) %>%
  # mutate(MyPresAbs = factor(MyPresAbs, levels = c("1","0"), labels = c("Presence", "Absence")))

CHabx 
length(unique(CHabx$SUBUNIT)) ## 5 units of critical land in total


## Presence Points
## filter from main df
# presProt <- CHabDataObsJoin %>%
#   filter(MyPresAbs == "Presence", Critical == "Yes") 
# 
# presNot <- CHabDataObsJoin %>%
#   filter(MyPresAbs == "Presence", Critical == "No")
# presNot


# Maps --------------------------------------------------------------------
# install.packages(c("USAboundaries", "rnaturalearth", "GSODR"))
# install.packages("basemaps")
# devtools::install_github("16EAGLE/basemaps")
library(basemaps)

# install.packages('osmdata')
library(osmdata)

lisbon_map <- get_map( getbb('lisbon'), source="stamen")

library(here)
library(viridis)
# library(USAboundaries) ## not available for r version, has been archived on cran
library(rnaturalearth)
library(GSODR)
library(ggrepel)
library(cowplot)
library(ggmap)

## transform to 3857

cntsx <- cnts %>% 
  st_transform(crs= 3857, remove=F) 

cntsx

## plot
m1 <- ggplot() +
  # basemap_ggplot(cntsx) +
  geom_sf(data=cnts) + ## rb9 boundary
  geom_sf(data=CHabx) + ## critical habitat
  # geom_sf(data=presProt, fill = "green", pch=21, size=2) +
  # geom_sf(data=presNot, fill = "red", pch=21, size=2) +
  # geom_sf(data)
  theme_bw()+
  scale_fill_viridis_d("Presence On Critical Habitat")+
  ggtitle("Predicted Presences in Critical Habitat")
m1

file.name1 <- "Figures/07_presence_on_critical_habitat.jpg"
ggsave(m1, filename=file.name1, dpi=300, height=5, width=8)


