### toad observations

### new observation data

# packages
library(tidyverse)
library(tidylog)
library(sf)
library(raster)
library(nhdplusTools)
library(readr)
library(mapview)

getwd()


# USGS observation data ----------------------------------------------------

bio <- read.csv("input_data/SCCWRP_BUMI_20220816.csv")
head(bio)
dim(bio)
# bio <- bio %>% filter(!Date1 %in% complete.cases(bio$Date1)) ## remove rows with no date

unique(bio$SurveyType) ## includes turtle, remove

sum(bio$SurveyMethod == "Turtle: Visual")

unique(bio$Date1)

## remove rows with no coords
## take only years until 2014
## make dummy ID variable
## remove tuttle from SurveyMethod

bio_sub <- bio %>% 
  filter(!is.na(StartLat), !is.na(StartLong)) %>%
  separate(Date1, into = c("Month", "Day", "Year"), remove = F, sep=" |/") %>% 
  filter(!Year > 14, !SurveyMethod %in% c("Turtle: Visual", "Turtle: Trapping")) %>%
  st_as_sf(coords=c( "StartLong", "StartLat"), crs=4326, remove=F) %>%
  mutate(ID = 1:length(geometry)) %>%
  mutate(ID = paste0("U", ID)) 

dim(bio_sub) ## 2164
head(bio_sub)

head(bio_sub)
range(bio_sub$Year)

## look at sites

# set background basemaps:
basemapsList <- c("Esri.WorldTopoMap", "Esri.WorldImagery",
                  "Esri.NatGeoWorldMap",
                  "OpenTopoMap", "OpenStreetMap", 
                  "CartoDB.Positron", "Stamen.TopOSMFeatures")

mapviewOptions(basemaps=basemapsList, fgb = FALSE)

## plot points
m1 <- mapview(bio_sub, cex=6, col.regions="orange",
              layer.name="Toad Observations USGS")# +
# mapview(bio_sub, cex=6, col.regions="blue",
#         layer.name="Toad Observations Other")  


m1
m1@map %>% leaflet::addMeasure(primaryLengthUnit = "meters")


# More observations data --------------------------------------------------

bio1 <- read.csv("input_data/arroyo_toad_SDRB9_occurrence_historicaldata_othersources.csv")
# bio2 <- read.csv("input_data/SDRB9_arroyo_toad_CarlsbadFWO_1991_2020.csv")
# dim(bio2)
# bio2
unique(bio1$OriginalSource)
## remove rows with no coords
## take only years between 1990 -  2014
## make dummy ID variable

bio1_sub <- bio1 %>% 
  filter(!is.na(Latitude), !is.na(Longitude)) %>%
  separate(EventDate, into = c("Month", "Day", "Year"), remove = F, sep="/") %>% 
  filter(Year %in% 1990:2014) %>%
  # dplyr::select(Latitude:Longitude)
  st_as_sf(coords=c("Longitude", "Latitude"), crs=4326, remove=F) %>%
  mutate(ID = 1:length(geometry)) %>%
  mutate(ID = paste0("H", ID)) 

head(bio1_sub)


# Observations from Chad --------------------------------------------------

chad1 <- read.csv("/Users/katieirving/Library/CloudStorage/OneDrive-SharedLibraries-SCCWRP/SD Hydro Vulnerability Assessment - General/Data/RawData/Toad_Data/FromChad/MOMsAL.csv.csv")
chad2 <- read.csv("/Users/katieirving/Library/CloudStorage/OneDrive-SharedLibraries-SCCWRP/SD Hydro Vulnerability Assessment - General/Data/RawData/Toad_Data/FromChad/SO_arroyo_toad.csv.csv")
chad3 <- read.csv("/Users/katieirving/Library/CloudStorage/OneDrive-SharedLibraries-SCCWRP/SD Hydro Vulnerability Assessment - General/Data/RawData/Toad_Data/FromChad/USFWS_R9Only.kml.csv")

head(chad3)

chad1_sub <- chad1 %>% 
  filter(!is.na(Latitude), !is.na(Longitude)) %>%
  rename(Year = SurYr, SurveyDate = SurDate, Species_1 = CName) %>% 
  filter(Year %in% 1990:2014) %>%
  mutate(Age = NA) %>%
  dplyr::select(SurveyDate, Year, Latitude, Longitude, Species_1, Age) %>%
  st_as_sf(coords=c("Longitude", "Latitude"), crs=4326, remove=F) %>%
  mutate(ID = 1:length(geometry))  %>%
    mutate(ID = paste0("C", ID)) 

chad2_sub <- chad2 %>% 
  filter(!is.na(Lat), !is.na(Long)) %>%
  rename(Latitude = Lat, Longitude = Long) %>%
  separate(SurveyDate, into = c("Month", "Day", "Year"), remove = F, sep="/") %>% 
  mutate(Year = as.integer(Year)) %>%
  filter(Year %in% 1990:2014)  %>%
  dplyr::select(SurveyDate, Year, Latitude, Longitude, Species_1, Age) %>%
  st_as_sf(coords=c("Longitude", "Latitude"), crs=4326, remove=F) %>%
  mutate(ID = 1:length(geometry)) %>%
  mutate(ID = paste0("Ct", ID)) 


chad3_sub <- chad3 %>% ### OCC here might be abundance, not sure though!
  filter(!is.na(Y), !is.na(X)) %>%
  rename(Latitude = Y, Longitude = X) %>%
  rename(Year = YEAR, SurveyDate = DATE_, Species_1 = CNAME) %>% 
  mutate(SurveyDate = as.character(SurveyDate)) %>%
  filter(Year %in% 1990:2014) %>%
  mutate(Age = NA) %>%
  dplyr::select( SurveyDate, Year, Latitude, Longitude, Species_1, Age) %>%
  st_as_sf(coords=c("Longitude", "Latitude"), crs=4326, remove=F) %>%
  mutate(ID = 1:length(geometry)) %>%
  mutate(ID = paste0("Cth", ID)) 

## join altogether

chad_sub <- bind_rows(chad1_sub, chad2_sub, chad3_sub)

## remove other species

unique(chad_sub$Species_1)

chad_sub <- chad_sub %>%
  filter(Species_1 %in% c("arroyo toad", "Arroyo toad", "Arroyo_toad"))

length(unique(chad_sub$ID))

# get COMIDs --------------------------------------------------------------

# Create dataframe for looking up COMIDS (here use all stations)
data_segs <- bio_sub %>%
  dplyr::select(ID, StartLat, StartLong) %>%
  distinct(ID, StartLat, StartLong) %>% 
  st_as_sf(coords=c("StartLong", "StartLat"), crs=4326, remove=F) %>%
  # st_transform(crs=32611) %>%
  arrange(ID)

crs(data_segs)
head(data_segs)
dim(data_segs)

# use nhdtools to get comids
data_all_coms <- data_segs %>%
  group_split(ID) %>%
  set_names(., data_segs$ID) %>%
  map(~discover_nhdplus_id(.x$geometry))

data_all_coms

# flatten into single dataframe instead of list
data_segs_df <-data_all_coms %>% flatten_dfc() %>% t() %>%
  as.data.frame() %>%
  rename("COMID"=V1) %>% rownames_to_column(var = "ID") 

head(data_segs_df)

bio_data2 <- full_join(bio_sub, data_segs_df, by = "ID")
object.size(bio_data2)

length(unique(bio_data2$COMID)) ## 331
head(bio_data2)

save(bio_data2, file = "ignore/01_al_bio_data_COMIDs.RData")
load(file = "ignore/01_al_bio_data_COMIDs.RData") # bio_data2

## other obs

# Create dataframe for looking up COMIDS (here use all stations)
data_segs <- bio1_sub %>%
  dplyr::select(ID, Latitude, Longitude) %>%
  distinct(ID, Latitude, Longitude) %>%
  st_as_sf(coords=c("Longitude",  "Latitude"), crs=4269, remove=F) %>%
  st_transform(crs=32611) %>%
  arrange(ID)

head(data_segs)

# # use nhdtools to get comids
data_all_coms <- data_segs %>%
  group_split(ID) %>%
  set_names(., data_segs$ID) %>%
  map(~discover_nhdplus_id(.x$geometry))

data_all_coms

# # flatten into single dataframe instead of list
data_segs_df <-data_all_coms %>% flatten_dfc() %>% t() %>%
  as.data.frame() %>%
  rename("COMID"=V1) %>% rownames_to_column(var = "ID")

head(data_segs_df)

bio_data3 <- full_join(bio1_sub, data_segs_df, by = "ID")
object.size(bio_data3)

length(unique(bio_data3$COMID)) ## 19

save(bio_data3, file = "ignore/01_al_bio_data_COMIDs_SDRB9.RData")
load(file = "ignore/01_al_bio_data_COMIDs_SDRB9.RData") # bio_data3

## chad obs

# Create dataframe for looking up COMIDS (here use all stations)
data_segs <- chad_sub %>%
  dplyr::select(ID, Latitude, Longitude) %>%
  distinct(ID, Latitude, Longitude) %>% 
  st_as_sf(coords=c("Longitude",  "Latitude"), crs=4326, remove=F) %>%
  st_transform(crs=32611) %>%
  arrange(ID)

crs(data_segs)
head(data_segs)
dim(data_segs)

length(unique(data_segs$ID))

# use nhdtools to get comids
data_all_coms <- data_segs %>%
  group_split(ID) %>%
  set_names(., data_segs$ID) %>%
  map(~discover_nhdplus_id(.x$geometry))

data_all_coms

# flatten into single dataframe instead of list
data_segs_df <-data_all_coms %>% flatten_dfc() %>% t() %>%
  as.data.frame() %>%
  rename("COMID"=V1) %>% rownames_to_column(var = "ID") 

head(data_segs_df)

bio_data4 <- full_join(chad_sub, data_segs_df, by = "ID")
object.size(bio_data2)

length(unique(bio_data4$COMID)) ## 314
head(bio_data4)

save(bio_data4, file = "ignore/01_chad_bio_data_COMIDs.RData")
load(file = "ignore/01_chad_bio_data_COMIDs.RData") # bio_data4

# add Mike's observations -------------------------------------------------

## add in Mikes observations, remove any that are duplicated

# original pres/abs
inshape="input_data/200mCells_PresAbs2005 PCA PresAbs Pts_MLT.shp" ## presence absence
## format
all_data_obs <- st_read(inshape) %>%
  mutate(Longitude = unlist(map(geometry,1)),
         Latitude = unlist(map(geometry,2))) %>%
  mutate(ID = 1:length(geometry)) %>%
  mutate(ID = paste0("M", ID)) ## p/a

head(all_data_obs)

# Create dataframe for looking up COMIDS (here use all stations)
data_segs <- all_data_obs %>%
  dplyr::select(ID, Latitude,Longitude) %>%
  distinct(ID, Latitude,Longitude) %>% 
  st_as_sf(coords=c("Longitude", "Latitude"), crs=32611, remove=F) %>%
  # st_transform(crs=32611) %>%
  arrange(ID)

# use nhdtools to get comids
data_all_coms <- data_segs %>%
  group_split(ID) %>%
  set_names(., data_segs$ID) %>%
  map(~discover_nhdplus_id(.x$geometry))

# flatten into single dataframe instead of list
data_segs_df <-data_all_coms %>% flatten_dfc() %>% t() %>%
  as.data.frame() %>%
  rename("COMID"=V1) %>% rownames_to_column(var = "ID") 

bio_data0 <- full_join(all_data_obs, data_segs_df, by = "ID")
object.size(bio_data0)

length(unique(bio_data0$COMID)) ## 218

save(bio_data0, file = "ignore/01_original_bio_data_COMIDs.RData")
load(file = "ignore/01_original_bio_data_COMIDs.RData")

# Join all presence/absence together (points) ---------------------------------------------

load(file = "ignore/01_original_bio_data_COMIDs.RData") #bio_data0
load(file = "ignore/01_chad_bio_data_COMIDs.RData") # bio_data4
load(file = "ignore/01_al_bio_data_COMIDs_SDRB9.RData") # bio_data3
load(file = "ignore/01_al_bio_data_COMIDs.RData") # bio_data2

head(bio_data0)

sum(bio_data0$PresAbs200 == 0) ## 89
sum(bio_data2$PresAbs200 == 0) ## 0 
sum(bio_data3$PresAbs200 == 0) ## 0
sum(bio_data4$PresAbs200 == 0) ## 0

head(bio_data2) 
dim(bio_data0)

## format: selected columns, make life stage counts long, 
# unique(bio$Count)
# unique(bio$Year)

head(bio_data2)
## USGS
bio <- bio_data2 %>%
  dplyr::select(BUMIcount, ID, COMID, StartLat, StartLong, Year) %>%
  rename(Latitude = StartLat, Longitude = StartLong) %>%
  pivot_longer(BUMIcount, names_to = "LifeStage", values_to = "Count") %>%
  mutate(PresAbs = ifelse(Count < 1, 0, 1), Year = paste0("20", Year)) %>%
  # filter(Year >= 2000) %>%
  distinct()

head(bio)


## other
bio1 <- bio_data3 %>%
  dplyr::select(COMID, Latitude, Longitude, ID, Year) %>%
  mutate(LifeStage = "ALL", PresAbs = 1) %>%
  # filter(Year >= 2000) %>%
  distinct()

## Chad
bio2 <- bio_data4 %>%
  dplyr::select(COMID, Latitude, Longitude, ID, Age, Year) %>%
  rename(LifeStage = Age) %>%
  mutate(PresAbs = 1, Year = as.character(Year)) %>%
  # filter(Year >= 2000) %>%
  distinct()

bio3 <- bio_data0 %>%
  dplyr::select(COMID, Latitude, Longitude, ID, PresAbs200) %>%
  st_transform(crs=4326) %>%
  mutate(Longitude = unlist(map(geometry,1)),
         Latitude = unlist(map(geometry,2))) %>%
  mutate( Year = NA,LifeStage = "ALL" ) %>%
  rename(PresAbs = PresAbs200) %>%
  distinct()

bio3
  
## join together

bio_points <- bind_rows(bio, bio1, bio2, bio3) %>% distinct()

dim(bio_points) ## 5438 - unique points
length(unique(bio_points$COMID)) ## 583 - unique comid
# subs <- bio_points %>% filter(Year >= 2000) 
# length(unique(subs$COMID)) ## 485 2000-2014
unique(bio_points$Year)

head(bio_points)

# Map points --------------------------------------------------------------

library(viridisLite)
library(tmaptools)

## upload ca boundary

ca_sf <- st_read("ignore/SpatialData/California/Ca_State_poly.shp")
## upload ca counties

counties_sf <- st_read("ignore/SpatialData/Counties/Counties.shp")

## get only socal
counties_socal_sf<-counties_sf %>%
  filter(NAME_PCASE %in% c("San Diego"))

## upload watersheds

unique(sheds_sf$CUNAME)

sheds_sf<- st_read("ignore/SpatialData/SMCSheds2009/SMCSheds2009.shp") %>%
  filter(HUNAME %in% c("SAN DIEGO", "SANTA MARGARITA", "SWEETWATER", "SAN JUAN", "SAN DIEGUITO"))
plot(sheds_sf)

## upload RB9 poly
cnts <- st_read("/Users/katieirving/Library/CloudStorage/OneDrive-SharedLibraries-SCCWRP/SD Hydro Vulnerability Assessment - General/Data/SpatialData/SD_RB9_boundary.shp") %>%
  st_transform(crs=st_crs(sheds_sf)) 
cnts

crs(cnts) == crs(sheds_sf)
## set bounding box 
st_bbox(bio_points)

beige_pal<-c("#f2dbb7","#eed9c4","#fff0db","#e4d5b7","#d9b99b",
             "#d9c2ba","#9c8481","#e2cbb0","#a69279","#f2dbb7",
             "#f6e6bf","#a69279","#f2dbb7","#9c8481","#e4d5b7")

unique(sheds_sf$HUNAME)

## plot 

m1 <- ggplot()+
  # geom_sf(data=ca_sf)+ ## california
  geom_sf(data = cnts) +
  geom_sf(data=sheds_sf, aes(fill=SMC_Name), color=NA)+ ## watersheds
  scale_fill_manual(values=beige_pal, guide= "none")+ ## beige colour for watersheds
  geom_sf(data=counties_socal_sf, fill=NA)+ ## counties
  geom_sf(data=bio_points, size = 2) + ## results
 
  # scale_colour_manual(values=c("chartreuse4", "dodgerblue2", "mediumpurple2", "firebrick3"))+ ## colour of points
  coord_sf(xlim=c(-119.41,-116.4), ## axis limits
           ylim=c(32.5, 34.8),
           crs=4326) +
  theme_bw()+
  theme(axis.title = element_blank(), ## clean background
        panel.grid = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank()) 
  # guides(size = "none") +
  # ggtitle(paste0(IndName,": ", metName)) + ## main title
  # facet_grid(rows = vars(BioResult), cols = vars(FlowResult)) ## facet by categories

m1

## includes points outside SD boundary

## save out

st_write(bio_points, "ignore/01_toad_obs_points_RB9.shp", append=FALSE)
bio_points <- st_read("ignore/01_toad_obs_points_RB9.shp")



# Plot snapped bio --------------------------------------------------------

## bio points were snapped to SD streams in GIS

## updated and snapped pres/abs
bioSnap <- shapefile("input_data/ToadsObs_SnapToRaster.shp")
head(bioSnap)

## make spatial
orig.sdata <-  bioSnap %>% as.data.frame() %>% ## get coordinates of snapped points
  # filter(!NEAR_DIST > 50) %>%
  dplyr::select(ID, COMID, grid_code, Year:PresAbs, Ras_Long, Ras_Lat) %>%
  st_as_sf(coords=c("Ras_Long", "Ras_Lat"), crs=4326, remove=F) %>%
  distinct(ID, .keep_all=T)

orig.sdata

## set bounding box 
st_bbox(sheds_sf)
st_crs(sheds_sf)
## plot 

m2 <- ggplot()+
  # geom_sf(data=ca_sf)+ ## california
  geom_sf(data = cnts, aes(fill = NA)) +
  geom_sf(data=sheds_sf, aes(fill=SMC_Name), color=NA)+ ## watersheds
  scale_fill_manual(values=beige_pal, guide= "none")+ ## beige colour for watersheds
  # geom_sf(data=counties_socal_sf, fill=NA)+ ## counties
  geom_sf(data=orig.sdata, size = 1) + ## results
  # coord_sf(xlim=c(-117.64823,-116.48997), ## axis limits
  #          ylim=c(32.56753, 33.66691),
  #          crs=4326) +
  theme_bw()+
  theme(axis.title = element_blank(), ## clean background
        panel.grid = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.border = element_blank()) 
# guides(size = "none") +
# ggtitle(paste0(IndName,": ", metName)) + ## main title
# facet_grid(rows = vars(BioResult), cols = vars(FlowResult)) ## facet by categories

m2

## create directory 
file.name1 <- "figures/01_snapped_toad_observations.jpg"
## save
ggsave(m2, filename=file.name1, dpi=500, height=10, width=15)
